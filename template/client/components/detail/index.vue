<i18n>
{
    "zh-cn": {
        "process.start":"提交认购",
        "process.pay":"扣款",
        "process.pay.error":"扣款失败",
        "process.publish":"公布中签",
        "process.reject":"驳回申请",
        "process.cancel":"撤销申请",
        "status.-2":"扣款失败",
        "status.0":"待扣款，资金冻结中",
        "status.1":"待公布，资金已扣除",
        "status.2.0":"已公布：未中签 {reason}",
        "status.2.1":"已公布：中签 {count} 股",
        "status.3":"已驳回 {reason}",
        "status.4":"已撤销：资金已解冻",
        "operator.modify":"修改",
        "operator.cancel":"撤销",
        "detail.createTime.lab":"提交认购时间",
        "detail.stock.lab":"认购新股",
        "detail.buyCount.lab":"认购股数",
        "detail.buyCount.shares":"{buyCount} 股",
        "detail.account.lab":"认购账户",
        "detail.type.lab":"认购方式",
        "detail.expense.lab":"银行融资利息",
        "detail.unfree.lab":"返还金额",
        "detail.amount.lab":"认购总额",
        "type.1.0.0":"现金认购",
        "type.1.0.1":"富途融资认购",
        "type.1.1":"优先认购",
        "type.2.0":"银行融资认购",
        "type.2.1":"0本金认购",
        "amount.cash.lab":"可提金额",
        "amount.futu.lab":"富途融资",
        "amount.margin.lab":"银行融资",
        "amount.fee.lab":"手续费",
        "amount.status.0":"已冻结",
        "amount.status.123":"已扣款",
        "amount.status.4":"已解冻",
        "date.0":"冻结日期",
        "date.-2123":"扣款日期",
        "date.4":"解冻日期",
        "margin.information":"银行融资利息详情",
        "margin.part":"计息金额",
        "margin.date":"计息日",
        "margin.date.suffix":"天",
        "margin.expense":"银行融资年利率",
        "margin.amount":"合计",
        "margin.know":"知道了",
        "dialog.tips": "提示",
        "dialog.sub":"确认",
        "dialog.canl":"取消",
        "dialog.confirm": "确认",
        "dialog.next": "继续",
        "dialog.hkd": "港币",
        "dialog.cancel": "确定要撤销该新股认购申请吗？",
        "dialog.cancel.success": "撤销申请成功",
        "dialog.cancel.error": "撤销申请失败",
        "dialog.modify":"银行融资认购只支持追加，修改后您使用银行融资的金额不得少于",
        "light.dialog.zero":"0本金认购不支持修改",
        "light.dialog.margin":"银行融资认购不支持撤销"
    },
    "zh-hk":{
        "process.start":"提交認購",
        "process.pay":"扣款",
        "process.pay.error":"扣款失敗",
        "process.publish":"公佈中籤",
        "process.reject":"駁回申請",
        "process.cancel":"撤銷申請",
        "status.-2":"扣款失敗",
        "status.0":"待扣款，資金凍結中",
        "status.1":"待公佈，資金已扣除",
        "status.2.0":"已公佈：未中籤 {reason}",
        "status.2.1":"已公佈：中籤 {count} 股",
        "status.3":"已駁回 {reason}",
        "status.4":"已撤銷：資金已解凍",
        "operator.modify":"修改",
        "operator.cancel":"撤銷",
        "detail.createTime.lab":"提交認購時間",
        "detail.stock.lab":"認購新股",
        "detail.buyCount.lab":"認購股數",
        "detail.buyCount.shares":"{buyCount} 股",
        "detail.account.lab":"認購帳戶",
        "detail.type.lab":"認購方式",
        "detail.expense.lab":"銀行孖展利息",
        "detail.unfree.lab":"返還金額",
        "detail.amount.lab":"認購總額",
        "type.1.0.0":"現金認購",
        "type.1.0.1":"富途孖展認購",
        "type.1.1":"優先認購",
        "type.2.0":"銀行孖展認購",
        "type.2.1":"0本金認購",
        "amount.cash.lab":"可提金額",
        "amount.futu.lab":"富途孖展",
        "amount.margin.lab":"銀行孖展",
        "amount.fee.lab":"手續費",
        "amount.status.0":"已凍結",
        "amount.status.123":"已扣款",
        "amount.status.4":"已解凍",
        "date.0":"凍結日期",
        "date.-2123":"扣款日期",
        "date.4":"解凍日期",
        "margin.information":"銀行孖展利息詳情",
        "margin.part":"計息金額",
        "margin.date":"計息日",
        "margin.date.suffix":"天",
        "margin.expense":"銀行孖展年利率",
        "margin.amount":"合計",
        "margin.know":"知道了",
        "dialog.tips": "提示",
        "dialog.sub":"確認",
        "dialog.canl":"取消",
        "dialog.confirm": "確認",
        "dialog.next": "繼續",
        "dialog.hkd": "港幣",
        "dialog.cancel": "確定要撤銷該新股認購申請嗎？",
        "dialog.cancel.success": "撤銷申請成功",
        "dialog.cancel.error": "撤銷申請失敗",
        "dialog.modify":"孖展認購只支持追加，修改後您使用孖展的金額不得少於",
        "light.dialog.zero":"0本金認購不支持修改",
        "light.dialog.margin":"銀行孖展認購不支持撤銷"
    },
    "en-us":{
        "process.start":"Submitted",
        "process.pay":"Deduction",
        "process.pay.error":"Deduction failed",
        "process.publish":"Announce",
        "process.reject":"Rejected",
        "process.cancel":"Canceled",
        "status.-2":"Deduction failed",
        "status.0":"Waiting deduction",
        "status.1":"Waiting for announcement",
        "status.2.0":"Not Allotted",
        "status.2.1":"{count} shares allotted",
        "status.3":"Rejected",
        "status.4":"Canceled",
        "operator.modify":"Edit",
        "operator.cancel":"Canceled",
        "detail.createTime.lab":"Submit subscription time",
        "detail.stock.lab":"Stock Name",
        "detail.buyCount.lab":"Shares",
        "detail.buyCount.shares":"{buyCount} shares",
        "detail.account.lab":"Subscription Account",
        "detail.type.lab":"Subscription Type",
        "detail.expense.lab":"Bank financing interest",
        "detail.unfree.lab":"Return amount",
        "detail.amount.lab":"Total subscription",
        "type.1.0.0":"Cash Subscription",
        "type.1.0.1":"FUTU Financing",
        "type.1.1":"Priority Subscription",
        "type.2.0":"IPO Financing",
        "type.2.1":"Zero Asset Subscription",
        "amount.cash.lab":"Amount Available",
        "amount.futu.lab":"Futu Financing",
        "amount.margin.lab":"Bank Financing",
        "amount.fee.lab":"Fee",
        "amount.status.0":"Already frozen",
        "amount.status.123":"Debited",
        "amount.status.4":"Thawed",
        "date.0":"Freeze date",
        "date.-2123":"Deduction date",
        "date.4":"Thaw date",
        "margin.information":"Interest description",
        "margin.part":"Amount",
        "margin.date":"Days",
        "margin.date.suffix":"days",
        "margin.expense":"Annual interest rate",
        "margin.amount":"Total",
        "margin.know":"Got it",
        "dialog.tips": "Tips",
        "dialog.sub":"confirm",
        "dialog.canl":"cancel",
        "dialog.confirm": "confirm",
        "dialog.next": "Carry on",
        "dialog.hkd": "HKD",
        "dialog.cancel": "Are you sure you want to cancel the subscription request for this new stock?",
        "dialog.cancel.success": "Successful canceled",
        "dialog.cancel.error": "Cancel failed",
        "dialog.modify":"Bank financing subscriptions only support an increase, and the amount of bank financing used after modification is not less than ",
        "light.dialog.zero":"Zero asset subscription does not support modification",
        "light.dialog.margin":"Bank financing subscriptions are irrevocable"
    }
}
</i18n>
</i18n>
<template>
<div class="wrapper detail-container">
    <div class="step-container">
        <!-- 扣款失败 -->
        <div class="ui-step-lateral ui-step-lane detail-step" :class="{isShow:isDetail}" v-if="detail.status === -2">
            <ul class="ui-step-wrapper">
                <li class="ui-step-item">
                    <p class="current ui-step-title">{{$t('process.start')}}</p>
                    <span class="ui-step-border"><i class="ui-step-round"></i></span>
                    <p class="current ui-step-text">{{formatDate((detail.createdAt || 0) * 1000 , 'yyyy-MM-dd')}}</p>
                </li>
                <li class="ui-step-item">
                    <p class="current ui-step-title">{{$t('process.pay.error')}}</p>
                    <i class="ui-step-round iconfont icon-checkright"></i>
                    <p class="current ui-step-text">{{formatDate((detail.processTime || 0) * 1000 , 'yyyy-MM-dd')}}</p>
                </li>
            </ul>
            <div class="ui-step-line">
                <p class="ui-line-item light-line"></p>
                <p class="ui-line-item deep-line" style="width: 100%;"></p>
            </div>
        </div>
        <!-- 待扣款 -->
        <div class="ui-step-lateral ui-step-lane" v-if="detail.status === 0">
            <ul class="ui-step-wrapper">
                <li class="ui-step-item">
                    <p class="current ui-step-title">{{$t('process.start')}}</p>
                    <i class="ui-step-round iconfont icon-checkright"></i>
                    <p class="current ui-step-text">{{formatDate((detail.createdAt || 0) * 1000 , 'yyyy-MM-dd')}}</p>
                </li>
                <li class="ui-step-item">
                    <p class="ui-step-title">{{$t('process.pay')}}</p>
                    <i class="ui-step-round"></i>
                    <p class="ui-step-text">{{formatDate((detail.expectedPayTime || 0) * 1000 , 'yyyy-MM-dd')}}</p>
                </li>
                <li class="ui-step-item">
                    <p class="ui-step-title">{{$t('process.publish')}}</p>
                    <i class="ui-step-round"></i>
                    <p class="ui-step-text">{{formatDate((detail.publishTime || 0) * 1000 , 'yyyy-MM-dd')}}</p>
                </li>
            </ul>
            <div class="ui-step-line">
                <p class="ui-line-item light-line"></p>
                <p class="ui-line-item deep-line" style="width: 0;"></p>
            </div>
        </div>
        <!-- 待公布 -->
        <div class="ui-step-lateral ui-step-lane detail-step" :class="{isShow:isDetail}" v-if="detail.status === 1">
            <ul class="ui-step-wrapper">
                <li class="ui-step-item">
                    <p class="current ui-step-title">{{$t('process.start')}}</p>
                    <span class="ui-step-border"><i class="ui-step-round"></i></span>
                    <p class="current ui-step-text">{{formatDate((detail.createdAt || 0) * 1000 , 'yyyy-MM-dd')}}</p>
                </li>
                <li class="ui-step-item">
                    <p class="current ui-step-title">{{$t('process.pay')}}</p>
                    <i class="ui-step-round iconfont icon-checkright"></i>
                    <p class="current ui-step-text">{{formatDate((detail.expectedPayTime || 0) * 1000 , 'yyyy-MM-dd')}}</p>
                </li>
                <li class="ui-step-item">
                    <p class="ui-step-title">{{$t('process.publish')}}</p>
                    <i class="ui-step-round"></i>
                    <p class="ui-step-text">{{formatDate((detail.publishTime || 0) * 1000 , 'yyyy-MM-dd')}}</p>
                </li>
            </ul>
            <div class="ui-step-line">
                <p class="ui-line-item light-line"></p>
                <p class="ui-line-item deep-line" style="width: 50%;"></p>
            </div>
        </div>
        <!-- 已公布 -->
        <div class="ui-step-lateral ui-step-lane detail-step" :class="{isShow:isDetail}" v-if="detail.status === 2">
            <ul class="ui-step-wrapper">
                <li class="ui-step-item">
                    <p class="current ui-step-title">{{$t('process.start')}}</p>
                    <span class="ui-step-border"><i class="ui-step-round"></i></span>
                    <p class="current ui-step-text">{{formatDate((detail.createdAt || 0) * 1000 , 'yyyy-MM-dd')}}</p>
                </li>
                <li class="ui-step-item">
                    <p class="current ui-step-title">{{$t('process.pay')}}</p>
                    <span class="ui-step-border"><i class="ui-step-round"></i></span>
                    <p class="current ui-step-text">{{formatDate((detail.expectedPayTime || 0) * 1000 , 'yyyy-MM-dd')}}</p>
                </li>
                <li class="ui-step-item">
                    <p class="current ui-step-title">{{$t('process.publish')}}</p>
                    <i class="ui-step-round iconfont icon-checkright"></i>
                    <p class="current ui-step-text">{{formatDate((detail.publishTime || 0) * 1000 , 'yyyy-MM-dd')}}</p>
                </li>
            </ul>
            <div class="ui-step-line">
                <p class="ui-line-item light-line"></p>
                <p class="ui-line-item deep-line" style="width: 100%;"></p>
            </div>
        </div>
        <!-- 已驳回 -->
        <div class="ui-step-lateral ui-step-lane detail-step" :class="{isShow:isDetail}" v-if="detail.status === 3">
            <ul class="ui-step-wrapper">
                <li class="ui-step-item">
                    <p class="current ui-step-title">{{$t('process.start')}}</p>
                    <span class="ui-step-border"><i class="ui-step-round"></i></span>
                    <p class="current ui-step-text">{{formatDate((detail.createdAt || 0) * 1000 , 'yyyy-MM-dd')}}</p>
                </li>
                <li class="ui-step-item">
                    <p class="current ui-step-title">{{$t('process.reject')}}</p>
                    <i class="ui-step-round iconfont icon-checkright"></i>
                    <p class="current ui-step-text">{{formatDate((detail.processTime || 0) * 1000 , 'yyyy-MM-dd')}}</p>
                </li>
            </ul>
            <div class="ui-step-line">
                <p class="ui-line-item light-line"></p>
                <p class="ui-line-item deep-line" style="width: 100%;"></p>
            </div>
        </div>
        <!-- 已撤销 -->
        <div class="ui-step-lateral ui-step-lane detail-step" :class="{isShow:isDetail}" v-if="detail.status === 4">
            <ul class="ui-step-wrapper">
                <li class="ui-step-item">
                    <p class="current ui-step-title">{{$t('process.start')}}</p>
                    <span class="ui-step-border"><i class="ui-step-round"></i></span>
                    <p class="current ui-step-text">{{formatDate((detail.createdAt || 0) * 1000 , 'yyyy-MM-dd')}}</p>
                </li>
                <li class="ui-step-item">
                    <p class="current ui-step-title">{{$t('process.cancel')}}</p>
                    <i class="ui-step-round iconfont icon-checkright"></i>
                    <p class="current ui-step-text">{{formatDate((detail.processTime || 0) * 1000 , 'yyyy-MM-dd')}}</p>
                </li>
            </ul>
            <div class="ui-step-line">
                <p class="ui-line-item light-line"></p>
                <p class="ui-line-item deep-line" style="width: 100%;"></p>
            </div>
        </div>
    </div>
    <div class="wrapper detail-info-container">
        <div class="wrapper detail-result-container">
            <span class="ipo-result-txt" v-if="detail.status === -2">{{$t('status.-2')}}</span>
            <span class="ipo-result-txt" v-if="detail.status === 0">{{$t('status.0')}}</span>
            <span class="ipo-result-txt" v-if="detail.status === 1">{{$t('status.1')}}</span>
            <span class="ipo-result-txt" v-if="detail.status === 2 && detail.finalCount > 0">{{$t('status.2.1' , {count:formatNumber(detail.finalCount || 0)}) }}</span>
            <span class="ipo-result-txt" v-if="detail.status === 2 && detail.finalCount <= 0">{{$t('status.2.0' , {reason:(detail.notAllottedReason ? '（' + detail.notAllottedReason + '）':'')}) }}</span>
            <span class="ipo-result-txt" v-if="detail.status === 3">{{$t('status.3' , {reason: (detail.rejectReason ? '：' + detail.rejectReason : '')})}}</span>
            <span class="ipo-result-txt" v-if="detail.status === 4">{{$t('status.4')}}</span>
            <a @click="cancelTask($event)" class="ipo-link" v-if="detail.isCanModify || detail.isCanCancel" :class="{forbidden:!detail.isCanCancel}">{{$t('operator.cancel')}}</a>
            <a @click="modifyTask($event)" class="ipo-link" v-if="detail.isCanModify || detail.isCanCancel" :class="{forbidden:!detail.isCanModify}">{{$t('operator.modify')}}</a>
        </div>
        <div class="wrapper detail-information-container">
            <div class="wrapper info-i"><span class="name">{{$t('detail.createTime.lab')}}</span><span class="value">{{formatDate((detail.createdAt || 0) * 1000 , 'yyyy-MM-dd HH:mm')}}</span></div>
            <div class="wrapper info-i"><span class="name">{{$t('detail.stock.lab')}}</span><span class="value" v-if="detail.stockCode">{{detail.stockCode + ' ' + detail.stockName}}</span></div>
            <div class="wrapper info-i"><span class="name">{{$t('detail.buyCount.lab')}}</span><span class="value">{{$t('detail.buyCount.shares' , {buyCount: formatNumber(detail.buyCount || 0)})}}</span></div>
            <div class="wrapper info-i"><span class="name">{{$t('detail.account.lab')}}</span><span class="value">{{detail.accountDesc}}</span></div>
            <div class="wrapper info-i">
                <span class="name">{{$t('detail.type.lab')}}</span>
                <span class="value">
                    <span v-if="detail.type === 1 && detail.highPri === 0 && detail.assetMargin === 0">{{$t('type.1.0.0')}}</span>
                    <span v-if="detail.type === 1 && detail.highPri === 0  && detail.assetMargin">{{$t('type.1.0.1')}}</span>
                    <span v-if="detail.type === 1 && detail.highPri === 1">{{$t('type.1.1')}}</span>
                    <span v-if="detail.type === 2 && !detail.zeroAsset">{{$t('type.2.0')}}</span>
                    <span v-if="detail.type === 2 && detail.zeroAsset">{{$t('type.2.1')}}</span>
                </span>
            </div>
            <div class="wrapper info-i" v-if="detail.type === 2">
                <span class="name">{{$t('detail.expense.lab')}} <i class="iconfont icon-info-b" @click="showExpense"></i></span>
                <span class="value">{{formatNumber(detail.expense || 0 , 2)}} HKD</span>
            </div>
            <div class="wrapper info-i" v-if="detail.status === 2 || detail.status === 3">
                <span class="name">{{$t('detail.unfree.lab')}}</span>
                <span class="value">{{formatNumber((detail.unfreezeAmount || 0) / 1000 , 2)}} HKD</span>
            </div>
            <div class="wrapper info-i">
                <span class="name">{{$t('detail.amount.lab')}}</span>
                <span class="value"><span class="amount">{{formatNumber((((detail.type === 2 ? detail.marginFee : detail.cashFee) + detail.buyAmount) || 0)/ 1000 , 2)}}</span> HKD</span>
            </div>
        </div>
        <div class="wrapper amount-container">
            <div class="wrapper">
                <div class="triangle-up"></div>
            </div>
            <div class="wrapper amount-information-container">
                <div class="wrapper info-i">
                    <span class="name">
                        {{$t('amount.cash.lab')}}
                        <span v-if="detail.status === 0">({{$t('amount.status.0')}})</span>
                        <span v-if="detail.status === 4">({{$t('amount.status.4')}})</span>
                        <span v-if="detail.status === 1 ||detail.status === 2 || detail.status === 3">({{$t('amount.status.123')}})</span>
                    </span>
                    <span class="value">{{formatNumber(((detail.cashPart - detail.assetMargin) > 0 ? (detail.cashPart - detail.assetMargin) : 0) / 1000 , 2)}} HKD</span>
                </div>
                <div class="wrapper info-i">
                    <span class="name">
                        {{$t('amount.futu.lab')}}
                        <span v-if="detail.status === 0">({{$t('amount.status.0')}})</span>
                        <span v-if="detail.status === 4">({{$t('amount.status.4')}})</span>
                        <span v-if="detail.status === 1 ||detail.status === 2 || detail.status === 3">({{$t('amount.status.123')}})</span>
                    </span>
                    <span class="value">{{formatNumber((detail.assetMargin || 0) / 1000 , 2)}} HKD</span>
                </div>
                <div class="wrapper info-i" v-if="detail.type === 2">
                    <span class="name">{{$t('amount.margin.lab')}}</span>
                    <span class="value">{{formatNumber((detail.marginPart || 0) / 1000 , 2)}} HKD</span>
                </div>
                <div class="wrapper info-i">
                    <span class="name">
                        {{$t('amount.fee.lab')}}
                        <span v-if="detail.status === 0">({{$t('amount.status.0')}})</span>
                        <span v-if="detail.status === 4">({{$t('amount.status.4')}})</span>
                        <span v-if="detail.status === 1 ||detail.status === 2 || detail.status === 3">({{$t('amount.status.123')}})</span>
                    </span>
                    <span class="value">{{formatNumber((detail.type === 2 ? detail.marginFee : detail.cashFee) / 1000 , 2)}} HKD</span>
                </div>
                <div class="wrapper info-i">
                    <span class="name">
                        <span v-if="detail.status === 0">{{$t('date.0')}}</span>
                        <span v-if="detail.status === -2 || detail.status === 1 || detail.status === 2 || detail.status === 3">{{$t('date.-2123')}}</span>
                        <span v-if="detail.status === 4">{{$t('date.4')}}</span>
                    </span>
                    <span class="value">{{formatDate((detail.processTime || 0) * 1000 , 'yyyy-MM-dd')}}</span>
                </div>
            </div>
        </div>
        <div class="ui-dialog-mask expense-info-mask" :class="{isShow:isShowExpense}"></div>
        <div class="ui-dialog-box expense-info"  :class="{isShow:isShowExpense}">
            <div class="ui-dialog">
                <div class="ui-dialog-header">
                    <h3 class="ui-dialog-header-title">{{$t('margin.information')}}</h3>
                </div>
                <div class="wrapper expense-show">
                    <div class="wrapper expense-i">
                        <label>{{$t('margin.part')}}</label>
                        <span class="txt">{{formatNumber((detail.marginPart || 0) / 1000 , 2)}} HKD</span>
                    </div>
                    <div class="wrapper expense-i">
                        <label>{{$t('margin.date')}}</label>
                        <span class="txt"><span>{{detail.marginInterestDay}} {{$t('margin.date.suffix')}}</span>(<span>{{formatDate((detail.deductTime || 0) * 1000 , 'MM/dd') + '-' + formatDate(detail.publishTime * 1000 , 'MM/dd')}}</span>)</span>
                    </div>
                    <div class="wrapper expense-i">
                        <label>{{$t('margin.expense')}}</label>
                        <span class="txt">{{formatNumber((detail.marginInterest || 0) / 1000  , 2)}}%</span>
                    </div>
                    <div class="wrapper expense-amunt">
                        <label>{{$t('margin.amount')}}</label>
                        <span class="txt-expense">{{formatNumber((detail.expense || 0) , 2)}} HKD</span>
                    </div>
                </div>
                <div class="ui-dialog-footer">
                    <button class="ui-btn" @click="closeExpense()">{{$t('margin.know')}}</button>
                </div>
                <i class="iconfont icon-close"  @click="closeExpense()"></i>
            </div>
        </div>
    </div>
    <ui-loading></ui-loading>
    <ui-dialog></ui-dialog>
    <ui-light-dialog></ui-light-dialog>
</div>
</template>

<script>
{{#xhr}}
import * as xhr from '@futuweb/tool-xhr2';
{{/xhr}}
import formatNumber from '../../utils/format-number';
import formatDate from '../../utils/format-date';

import {checkResponse , handlerError} from '../../lib/response';
import getUrlKey from '../../utils/get-url-key';

import uiLoading from '../common/loading.vue';
import uiDialog from '../common/dialog.vue';
import uiLightDialog from '../common/light-dialog.vue';

const myFutu5 = _params.myFutu5 || 'my.futu5.com';

export default {
    name: 'ipo-detail',
    data(){
        return {
            myFutu5,
            isDetail: false,
            isCanceling: false,
            isShowExpense: false,
            isCanOperateTime: 0,
            detail: {},
        };
    },
    methods:{
        formatDate,
        formatNumber,
        getMarginInterestDays(deductTime , publishTime){
            deductTime = new Date(+deductTime);
            publishTime = new Date(+publishTime);
            // 先获取当日0点的日期对象，去除时间差异
            deductTime = new Date(deductTime.getFullYear(), deductTime.getMonth(), deductTime.getDate(), 0, 0, 0, 0);
            publishTime = new Date(publishTime.getFullYear(), publishTime.getMonth(), publishTime.getDate(), 0, 0, 0, 0);
            let  deltaDays = Math.round((publishTime - deductTime) / 24 / 3600 / 1000);
            return deltaDays >= 0 ? deltaDays : 0;
        },
        getInterestExpense(amount, day , interest){
            return amount * (interest / 100000 / 365) * day;
        },
        setDetail(detail){
            console.log('[ setDetail ] detail is : ' , detail);
            this.isDetail = true;
            this.detail = Object.assign({} , detail);
            //计息日
            this.detail.marginInterestDay = this.getMarginInterestDays(detail.deductTime * 1000 , detail.publishTime * 1000);
            //计息金额
            this.detail.expense = this.getInterestExpense((detail.marginPart || 0) / 1000 , this.detail.marginInterestDay , detail.marginInterest || 0);

            this.detail.isCanModify = false;
            this.detail.isCanCancel = false;
            this.isCanOperateTime = +this.detail.status === 0 && +new Date() < this.detail.expectedPayTime * 1000 ? 1 : 0;

            if ( this.isCanOperateTime ){//未处理的任务，并且在未扣款时间 。 可以进行操作
                if ( this.detail.type === 2 ){//银行融资
                    if ( this.detail.zeroAsset ){ //0本金认购可以撤销
                        if ( +new Date((+this.detail.marginEndTime || 0) * 1000) > +new Date() ){ //支持银行融资
                            this.detail.isCanCancel = true;
                        }
                    } else {
                        if ( +new Date(Math.min(this.detail.marginUpdateEndTime , this.detail.marginEndTime) * 1000) > +new Date() ){
                            this.detail.isCanModify = true; //银行融资可以修改
                        }
                    }
                }else{//普通
                    this.detail.isCanModify = true;
                    this.detail.isCanCancel = true;
                }
            }
        },
        showError(error){
            console.log('[showError] error: ' , error.message);
            this.$store.commit('showDialog' , error.message || 'Error');
        },
        getDetail(tid , stockCode){
            this.$store.commit('showLoading');
            return xhr.get({url:'/api/getIPODetail' , data:{tid,stockCode}})
                .then(checkResponse , handlerError)
                .then(this.setDetail.bind(this) , this.showError.bind(this))
                .then(()=>{
                    this.$store.commit('hideLoading');
                });
        },
        /**
         * 更改任务
        */
        modifyTask(e){
            e.preventDefault();

            if ( !this.detail.isCanModify ){
                if ( this.detail.type === 2 && this.detail.zeroAsset ){
                    this.$store.dispatch('showLight' , this.$t('light.dialog.zero'));
                }
                return;
            }

            if ( !this.detail.taskId || this.detail.zeroAsset ) return;

            let modifyUrl = '//' + this.myFutu5 + '/ipo/apply?stockCode=' + this.detail.stockCode + '&taskId=' + this.detail.taskId;
            //融资认购
            if ( +this.detail.type === 2 ){
                let message = this.$t('dialog.modify') + this.formatNumber(this.detail.marginPart / 1000 , 2) + this.$t('dialog.hkd');
                return this.$store.commit('showDialog' , {
                    title: this.$t('dialog.tips'),
                    canl: this.$t('dialog.canl'),
                    sub: this.$t('dialog.confirm'),
                    message,
                    callBack: ()=>{
                        return window.location.href = modifyUrl;
                    }
                });
            }
            return window.location.href = modifyUrl;
        },
        /**
         * 撤销任务
        */
        cancelCallBack(id){
            this.$store.commit('hideDialog');
            this.$store.commit('showLoading');
            this.isCanceling = true;
            return xhr.post({url:'/api/cancelIPOTask' , data:{id} ,dataType:'JSON'})
                .then(checkResponse , handlerError)
                .then(()=>{
                    this.$store.commit('hideLoading');
                    this.$store.commit('showDialog' ,{
                        title: this.$t('dialog.tips'),
                        canl: this.$t('dialog.canl'),
                        sub: this.$t('dialog.confirm'),
                        message: this.$t('dialog.cancel.success'),
                        callBack:()=>window.location.reload(true),
                        canlBack:()=>window.location.reload(true)
                    });
                } , (error)=>{
                    this.$store.commit('hideLoading');
                    this.$store.commit('showDialog' ,{
                        title: this.$t('dialog.tips'),
                        canl: this.$t('dialog.canl'),
                        sub: this.$t('dialog.confirm'),
                        message: this.$t('dialog.cancel.error')
                    });
                }).then(()=>{
                    this.isCanceling = false;
                });
        },
        cancelTask(e){
            e.preventDefault();
            if ( !this.detail.isCanCancel ){
                if ( this.detail.type === 2 && !this.detail.zeroAsset ){
                    this.$store.dispatch('showLight' , this.$t('light.dialog.margin'));
                }
                return;
            }
            if ( this.isCanceling ) return;
            if ( !this.detail.taskId ) return;

            return this.$store.commit('showDialog' ,{
                title: this.$t('dialog.tips'),
                canl: this.$t('dialog.canl'),
                sub: this.$t('dialog.confirm'),
                message: this.$t('dialog.cancel'),
                callBack: this.cancelCallBack.bind(this , this.detail.taskId)
            });
        },
        closeExpense(){
            this.isShowExpense = false;
        },
        showExpense(){
            this.isShowExpense = true;
        }
    },
    mounted(){
        let self = this;
        self.$nextTick(function(){
            let tid = +getUrlKey('tid') || 0;
            let stockCode = getUrlKey('stockCode') || '';
            // 不验tid,兼容牛牛客户端请求
            if (!stockCode ){
                return window.location.href = '/history';
            }
            self.getDetail(tid , stockCode);
        });
    },
    components: {uiLoading , uiDialog , uiLightDialog}
};
</script>
