<i18n>
{
    "zh-cn": {
        "alerts": [
            "新股认购列表将于交易日9:30更新，支持银行融资认购的新股融资额度将于交易日中午12:00前更新",
            {
                "path": "{0}",
                "slot": {
                    "txt": "新股认购、暗盘交易提醒功能已上线，点击查看详情。",
                    "url": "//{wwwFutunn}/act/detail?id=1406"
                }
            }
        ],
        "warning": {
            "path": "抱歉您的证券账户尚未开通，暂时无法认购新股。{0}",
            "slot": {
                "txt": "立即开通账户",
                "url": "//{wwwFutu5}/setup"
            }
        },
        "calendar": {
            "title": "新股日历",
            "header": "即将上市港股",
            "subHeaders": ["股票", "操作", "招股价", "每手股数", "入场费", "招股书"],
            "weekDays": ["日", "一", "二", "三", "四", "五", "六"],
            "operations": {
                "modify": "修改",
                "cancel": "撤销",
                "apply": "认购",
                "detail": "查看",
                "mobileDetail": "查看详情"
            },
            "content": {
                "info01": "可银行融资，",
                "info02": "倍杠杆",
                "info03": "招股书",
                "info04": "入场费",
                "info05": "（每手",
                "info06": "股）",
                "info07": "截止时间",
                "info08": "上市时间"
            },
            "illustrations": {
                "newStockStatusApply": "认购时间",
                "newStockStatusPublish": "公布结果",
                "newStockStatusIpo": "上市日期"
            }
        },
        "dialog": {
            "tip": "提示",
            "confirm": "确认",
            "cancel": "取消",
            "next": "继续",
            "successMsg": "撤销申请成功",
            "contentMsg01": "确定要撤销该新股认购申请吗？",
            "contentMsg02": "银行融资认购只支持追加，修改后您使用银行融资的金额不得少于",
            "contentMsg03": "港币"
        },
        "nodata": "暂无新股",
        "tips": [
            "温馨提示：",
            "1、富途证券新股认购支持现金认购、富途融资认购和银行融资认购。其中富途融资认购指客户使用到了富途融资进行新股认购，其中包括未交收金额和持仓股票抵押额，如果您开启统一购买力，还将包含您在美股/A股通关联账户资产抵押产生的购买力。",
            {
                "path": "2、认购手续费：50港币/笔（{0}期间，在认购截止后7个工作日返还50港币/笔），若使用到银行融资则为100港币/笔（代银行收取）。手续费和融资利息，无论是否中签，均需缴纳。手续费减免活动请以活动详情说明为准。{1}",
                "slots": [{
                    "txt": "0手续费活动",
                    "url": "//{wwwFutunn}/act/detail?id=999"
                },{
                    "txt": "查看收费详情",
                    "url": "//{helpFutu5}/faq/topic46"
                }]
            },
            "3、认购资金将在发起申请后实时冻结，并将于富途认购截止日当天扣除。",
            "4、银行融资认购不支持撤销，仅支持在富途认购截止日9:00前提交追加申请，富途认购截止日9:00后不支持追加修改。",
            "5、因银行融资认购不可撤销，若认购期间账户风险状态处于\"危险\"状态，富途将保留强平权利，请注意风险。",
            "6、因需处理认购手续，富途认购截止时间会早于交易所公布的日期，截止时间为提前一个交易日16:00。",
            {
                "path": "详情请查看{0}",
                "slots": [{
                    "txt": "《富途证券新股认购声明》",
                    "url": "//{helpFutu5}/faq/topic2297"
                }]
            }
        ]
    },
    "zh-hk": {
        "alerts": [
            "新股認購列表將于交易日9:30更新，支持銀行孖展認購的新股孖展額度將于交易日中午12:00前更新",
            {
                "path": "{0}",
                "slot": {
                    "txt": "新股認購、暗盤交易提醒功能已上線，點擊查睇詳情。",
                    "url": "//{wwwFutunn}/act/detail?id=1412"
                }
            }
        ],
        "warning": {
            "path": "抱歉您的證券帳戶尚未開通，暫時無法認購新股。{0}",
            "slot": {
                "txt": "立即開通賬戶",
                "url": "//{wwwFutu5}/setup"
            }
        },
        "calendar": {
            "title": "新股日曆",
            "header": "即將上市港股",
            "subHeaders": ["股票", "操作", "招股價", "每手股數", "入場費", "招股書"],
            "weekDays": ["日", "一", "二", "三", "四", "五", "六"],
            "operations": {
                "modify": "修改",
                "cancel": "撤銷",
                "apply": "認購",
                "detail": "查看",
                "mobileDetail": "查看詳情"
            },
            "content": {
                "info01": "可銀行孖展，",
                "info02": "倍槓桿",
                "info03": "招股書",
                "info04": "入場費",
                "info05": "（每手",
                "info06": "股）",
                "info07": "截止時間",
                "info08": "上市時間"
            },
            "illustrations": {
                "newStockStatusApply": "認購時間",
                "newStockStatusPublish": "公佈結果",
                "newStockStatusIpo": "上市日期"
            }
        },
        "dialog": {
            "tip": "提示",
            "confirm": "確認",
            "cancel": "取消",
            "next": "繼續",
            "successMsg": "撤銷申請成功",
            "contentMsg01": "確定要撤銷該新股認購申請嗎？",
            "contentMsg02": "銀行孖展認購只支持追加，修改後您使用銀行孖展的金額不得少於",
            "contentMsg03": "港幣"
        },
        "nodata": "暫無新股",
        "tips": [
            "溫馨提示：",
            "1、富途證券新股認購支持現金認購、富途孖展認購和銀行孖展認購。其中富途孖展認購指客戶使用到了富途孖展進行新股認購，其中包括未交收金額和持倉股票抵押額，如果您開啟統一購買力，還將包含您在美股/A股通關聯帳戶資產抵押產生的購買力。",
            {
                "path": "2、認購手續費：50港幣/筆（{0}期間，在認購截止後7個工作日返還50港幣/筆），若使用到銀行孖展則為100港幣/筆（代銀行收取）。手續費和孖展利息，無論是否中簽，均需繳納。手續費減免活動請以活動詳情說明為準。{1}",
                "slots": [{
                    "txt": "0手續費活動",
                    "url": "//{wwwFutunn}/act/detail?id=999"
                },{
                    "txt": "查看收費詳情",
                    "url": "//{helpFutu5}/faq/topic46"
                }]
            },
            "3、認購資金將在發起申請後即時凍結，並將于富途認購截止日當天扣除。",
            "4、銀行孖展認購不支持撤銷，僅支持在富途認購截止日9:00前提交追加申請，富途認購截止日9:00後不支持追加修改。 ",
            "5、因銀行孖展認購不可撤銷，若認購期間帳戶風險狀態處于\"危險\"狀態，富途將保留砍倉權利，請注意風險。",
            "6、因需處理認購手續，富途認購截止時間會早于交易所公布的日期，截止時間為提前一個交易日16:00。",
            {
                "path": "詳情請查看 {0}",
                "slots": [{
                    "txt": "《富途證券新股認購聲明》",
                    "url": "//{helpFutu5}/faq/topic2297"
                }]
            }
        ]
    },
    "en-us": {
        "alerts": [
            "The IPO subscription list will update at 9:30 on every trading day. Selected IPO(s) that offer IPO Financing Service will announce details before 12:00.",
            {
                "path": "{0}",
                "slot": {
                    "txt": "IPO subscription, grey market trading reminder function is online, click here to view details.",
                    "url": "//{wwwFutunn}/act/detail?id=1406"
                }
            }
        ],
        "warning": {
            "path": "Sorry, your securities account has not been opened yet, and you are temporarily unable to subscribe to new shares. {0}",
            "slot": {
                "txt": "Open account now",
                "url": "//{wwwFutu5}/setup"
            }
        },
        "calendar": {
            "title": "IPO List",
            "header": "HK Stocks",
            "subHeaders": ["Stock Name", "Operation", "Price", "Shares per lot", "Offering price", "Prospectus"],
            "weekDays": ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
            "operations": {
                "modify": "Edit",
                "cancel": "Cancel",
                "apply": "Subscribe",
                "detail": "Detail",
                "mobileDetail": "Details"
            },
            "content": {
                "info01": "Offer Bank Financing Service,",
                "info02": "X Leveraged",
                "info03": "Prospectus",
                "info04": "Offering price",
                "info05": "(",
                "info06": " shares per lot)",
                "info07": "Deadline",
                "info08": "Date of Listing"
            },
            "illustrations": {
                "newStockStatusApply": "Subscription time",
                "newStockStatusPublish": "Announcement time",
                "newStockStatusIpo": "Listing Date"
            }
        },
        "dialog": {
            "tip": "Tips",
            "confirm": "Confirm",
            "cancel": "Cancel",
            "next": "Carry on",
            "successMsg": "Successful canceled",
            "contentMsg01": "Are you sure you want to cancel the subscription request for this new stock?",
            "contentMsg02": "Bank financing subscriptions only support an increase, and the amount of bank financing used after modification is not less than ",
            "contentMsg03": " HKD"
        },
        "nodata": "Opps, no result found",
        "tips": [
            "Tips:",
            "1. Futu Securities' IPO Subscription offers Cash Subscription, Futu Financing Service and Bank Financing Service. Futu Financing Service allows you to subscribe to IPO using the unified purchasing power from all of your stock accounts including the A-share stock account, Hong Kong stock account and US stock account (subjected to the status of your account and client must have activated the function).",
            {
                "path": "2. Handling Fee: Successful IPO subscription by Cash Subscription or Futu Financing Service will have a $HKD 50 handling fee, it will be refunded within 7 working days for unsuccessful subscription. IPO subscription by Bank Financing Service will have a $100 handling fee, it will not be refunded in any case. {0}",
                "slots": [{
                    "txt": "View charge details",
                    "url": "//{helpFutu5}/faq/topic46"
                }]
            },
            "3. The subscription amount and handling fee will be frozen once you subscribed to the IPO. The amount will be deducted by the deadline of the IPO.",
            "4. IPO subscription by Bank Financing Service requires prior application submitted before 9:00 on the last date of the IPO. Withdrawal is not allowed.",
            "5. Since Bank Financing IPO Subscription is irrevocable, Futu reserves the right to compulsory liquidation during the IPO subscription period if the risk level of your account appears to be \"Dangerous\". Please pay attention to the risk level of your account.",
            "6. Due to our internal process, IPO subscription deadline at Futu will be one day earlier than the date announced by the Hong Kong Stock Exchange.",
            {
                "path": "For details, please refer to the {0}",
                "slots": [{
                    "txt": "Futu Securities IPO Subscription Statement",
                    "url": "//{helpFutu5}/faq/topic2297"
                }]
            }
        ]
    }
}
</i18n>
<template>
<div class="ipo-list-wapper">
    <div v-if="render">
        <div class="ui-alert" v-if="render.isUpIpoTime" >
            <i class="ui-badge ui-icon icon-sound"></i><span class="ui-alert-info">{{$t("alerts[0]")}}</span>
        </div>
        <div class="ui-alert" v-else>
            <i class="ui-badge ui-icon icon-sound"></i><i18n path="alerts[1].path" class="ui-alert-info"><a :href="parseUrl($t('alerts[1].slot.url')) || '#'" target="_blank">{{$t('alerts[1].slot.txt') || ''}}</a></i18n>
        </div>
        <i18n path="warning.path" class="ui-alert ui-alert-warning" v-show="!render.isSetup" tag="div">
            <a :href="parseUrl($t('warning.slot.url')) || '#'">{{$t('warning.slot.txt') || ''}}</a>
        </i18n>
        <!-- PC端图表开始 -->
        <div class="row ipo-calendar-container" :class="{show:render.isHasNewStock}">
            <h4 class="sm-title">{{$t("calendar.title")}}</h4>
            <div class="row">
                <table class="ui-table newStockListTable">
                    <tr class="tr-noHover">
                        <th colspan="6">{{$t("calendar.header")}}</th>
                        <th v-for="(dateItem, index) in render.calendarList" :key="index">{{dateItem.weekDay}}</th>
                        <th :rowspan="render.newStockList.length + 2" class="newStockSwitchPeriod" @click="switchCalender()">
                            <span v-if="render.calendarIndex==0"><i class="ui-icon icon-arrow01-right"></i></span>
                            <span v-if="render.calendarIndex==1"><i class="ui-icon icon-arrow01-left"></i></span>
                        </th>
                    </tr>
                    <tr>
                        <th :class="{alignLeft: +idx===0}" v-for="(subHeader, idx) in $t('calendar.subHeaders')" :key="`subHeader-${idx}`">{{subHeader}}</th>
                        <th v-for="(dateItem, index) in render.calendarList" :key="`date-${index}`">{{dateItem.date}}</th>
                    </tr>
                    <!-- 实际展示的数据开始 -->
                    <tr v-for="(newStock, idx) in render.newStockList" :key="idx">
                        <td class="alignLeft">
                            <a class="block" :href="newStock.companyInfo" target="_blank">{{newStock.stockDesc}}</a>
                            <span class="ipo-margin-tips" v-if="newStock.isShowMarginTip">{{$t("calendar.content.info01")}}<span>{{newStock.marginLeverage}}</span>{{$t("calendar.content.info02")}}</span>
                        </td>
                        <td><a class="ipo-link" v-for="(operation, idx) in newStock.operations" :key="idx" :href="operation.href" @click="handleOperation(operation.action, newStock.id)">{{operation.text}}</a></td>
                        <td>{{(newStock.price/1000) | number(3)}}</td>
                        <td>{{newStock.lotSize | number}}</td>
                        <td>{{(newStock.admission/1000) | number(2)}}</td>
                        <td><a :href="newStock.prospectusUrl" class="newStockDownloadLink"><i class="fileicon"></i></a></td>
                        <td v-for="(calendarItem, idx) in newStock.calendar[render.calendarIndex]" :key="idx" :class="calendarItem.className"></td>
                    </tr>
                    <!-- 实际展示的数据结束 -->
                </table>
            </div>
        </div>
        <!-- PC端图表结束 -->
        <!--PC:图例开始-->
        <div class="newStockListIllustrations">
            <div class="illustrationsWrapper" v-for="(key, idx) in Object.keys(illustrations)" :key="idx">
                <div class="illustrationsIcon" :class="illustrations[key].class"></div>
                <span>{{illustrations[key].txt}}</span>
            </div>
        </div>
        <!--PC:图例结束-->
        <!--Mobile:新股列表开始-->
        <div class="ipo-mb-list-container" :class="{show:render.newStockList && render.newStockList.length > 0}">
            <div class="newStockItem us-card" v-for="(newStock, index) in render.newStockList" :key="index">
                <div class="newStockHeader">
                    <div class="row ipo-mb-i-header us-card-header">
                        <a class="title-link" :href="newStock.companyInfo" target="_blank">{{newStock.stockName + ' ' + newStock.stockCode + '.HK'}}</a>
                        <span class="block ipo-margin-tips" v-if="newStock.supportMargin && !newStock.isOverMarginTime">{{$t("calendar.content.info01")}}<span>{{newStock.marginLeverage}}</span>{{$t("calendar.content.info02")}}</span>
                        <a :href="newStock.prospectusUrl" class="download">{{$t("calendar.content.info03")}}<i class="ui-icon icon-arrow01-right"></i></a>
                    </div>
                </div>
                <div class="newStockBody us-card-body">
                    <div class="newStockBodyItem us-card-item">
                        <label class="us-card-title">{{$t("calendar.content.info04")}}</label>
                        <span class=" us-card-detail">
                            <span class="admission">{{(newStock.admission/1000) | number(2)}}</span>
                            <span class="gray01">{{$t("calendar.content.info05")}}{{newStock.lotSize | number}}{{$t("calendar.content.info06")}}</span>
                        </span>
                    </div>
                    <div class="newStockBodyItem us-card-item">
                        <label class="us-card-title">{{$t("calendar.content.info07")}}</label>
                        <span class=" us-card-detail">{{newStock.actualEndTime | date('yyyy/MM/dd HH:mm:ss')}}</span>
                    </div>
                    <div class="newStockBodyItem us-card-item">
                        <label class="us-card-title">{{$t("calendar.content.info08")}}</label>
                        <span class=" us-card-detail">{{newStock.boardTime*1000 | date('yyyy/MM/dd')}}</span>
                    </div>
                </div>
                <div class="newStockFooter" v-if="render.isSetup && (newStock.applyDetail || (newStock.operations && newStock.operations.length))">
                    <a class="ui-btn ui-btn-s" :class="{'ui-btn-stroke': operation.notGray, 'ui-btn-strokeGray': !operation.notGray}" v-for="(operation, idx) in newStock.operations" :key="idx" :href="operation.href" @click="handleOperation(operation.action, newStock.id)">{{operation.mobileText || operation.text}}</a>
                </div>
            </div>
        </div>

    </div>
    <!-- empty -->
    <div class="row empty-container" v-if="!render || !render.isHasNewStock">
        <span class="empty">
            <span class="empty-box"></span>
            <span class="empty-txt">{{$t("nodata")}}</span>
        </span>
    </div>
    <!-- 温馨提示开始 -->
    <div class="row ipo-tips-container us-ipo-tips" >
        <i18n v-for="(tip, idx) in $t('tips')" :key="idx" :path="tip.path ? `tips[${idx}].path` : `tips[${idx}]`" tag="p">
            <template v-if="tip.slots"><a :href="parseUrl(slot.url) || '#'" v-for="(slot, index) in tip.slots" :key="index">{{(slot && slot.txt) || slot || ''}}</a></template>
        </i18n>
    </div>
    <!-- 温馨提示结束 -->
    <ui-loading></ui-loading>
    <ui-dialog></ui-dialog>
    <ui-light-dialog></ui-light-dialog>
</div>
</template>
<script>
{{#xhr}}
import * as xhr from '@futuweb/tool-xhr2';
{{/xhr}}
import date from './date';
import {checkResponse , handlerError} from '../../lib/response';
import uiLoading from '../common/loading.vue';
import uiDialog from '../common/dialog.vue';
import uiLightDialog from '../common/light-dialog.vue';
import numberFilter from '../../utils/format-number/index';
import formatDate from '../../utils/format-date/index';

const illustrations = ["newStockStatusApply", "newStockStatusPublish", "newStockStatusIpo"]

export default {
    data() {
        return {
            domain: _params.domain,
            isCanceling: false,
            illustrations: illustrations.reduce((ret, illustration) => {
                ret[illustration] = {
                    class: illustration,
                    txt: this.$t(`calendar.illustrations.${illustration}`)
                };
                return ret;
            }, {}),
            render: null
        }
    },
    filters: {
        number: numberFilter,
        date: formatDate
    },
    methods: {
        // i18n中url根据域名解析
        parseUrl(url) {
            let regx = /{(\w+)}/g;
            url = url.replace(regx, (...args) => {
                let domainName = args[1];
                return _params.domain[domainName]
            })
            return url;
        },
        /**
         * [isUpIpoTime 是不是更新列表时间 [6:00 , 12:00]]
         * @return {Boolean} [true|false]
         */
        isUpIpoTime() {
            let now = new Date();
            let hours = now.getHours();
            if ( hours >= 5 && hours <= 11 ){
                return true;
            }
            return false;
        },
        /**
         * [getCalendarDay 获取当日数据]
         * @param  {[type]} day [Date]
         * @return {[type]}     [description]
         */
        getCalendarDay(day){
            day = typeof day === 'number' ? new Date(day) : day;
            let d = day.getDate();
            // 获取一星期天数数组
            let week = Array.from({length: 7}, (_, v) => this.$t("calendar.weekDays")[v]);
            return {
                weekDay: week[day.getDay()],
                date: d > 9 ? ('' + d) : ('0' + d)
            };
        },
        /**
         * [getCalendar 获取日历]
         * @param  {[type]} calendarIndex [description]
         * @param  {[type]} size          [2周]
         * @return {[type]}               [description]
         */
        getCalendar(calendarIndex , size){
            // 获取日历数据
            let firstDate = !calendarIndex ? new Date() : new Date(+new Date() + (size * 5 * calendarIndex) * 24 * 3600 * 1000 );
            let weeks = date.getWeeks(size , firstDate);
            let calendarList = [];
            for ( let i = 0 ; i < weeks.length - 4 ; i++ ){
                calendarList.push(this.getCalendarDay(weeks[i]));
            }
            return calendarList;
        },
        /**
         * 切换日历
         * @param {number} index 第几段（两周一段），目前取0或者1
         * @return {void}
         */
        switchCalender(index) {
            if(typeof index === 'undefined'){
                this.render.calendarIndex = +!this.render.calendarIndex;
            }else{
                this.render.calendarIndex = index;
            }
            this.render.calendarList = this.getCalendar(this.render.calendarIndex , 2);
        },
        /**
         * [getCurrentTaskByStockId 获取当前任Id
         * @param  {[type]} stockId [description]
         * @return {[type]}         [description]
         */
        getCurrentTaskByStockId(stockId){
            let newStockList = [];
            if( this.render.newStockList ){
                newStockList = this.render.newStockList || [];
            }
            for ( let i = 0 ; i < newStockList.length ; i++ ){
                if ( +newStockList[i].id === +stockId ){
                    return Object.assign({} , newStockList[i]);
                }
            }
            return void 0;
        },
        // 撤销任务回调函数
        cancelTaskCallBack(taskId) {
            if ( this.isCanceling || !taskId) return;
            this.$store.commit('hideDialog');
            this.$store.commit('showLoading');
            this.isCanceling = true;
            return xhr.post({url:'/api/cancelIPOTask' , data:{id: taskId} ,dataType:'JSON'})
                .then(checkResponse , handlerError)
                .then(()=>{
                    this.$store.commit('hideLoading');
                    this.$store.commit('showDialog' ,{
                        title: this.$i18n.t('dialog.tip'),
                        canl: this.$i18n.t('dialog.cancel'),
                        sub: this.$i18n.t('dialog.confirm'),
                        message: this.$i18n.t('dialog.successMsg'),
                        callBack:()=>window.location.reload(true),
                        canlBack:()=>window.location.reload(true)
                    });
                } , (error)=>{
                    this.$store.commit('hideLoading');
                    this.$store.commit('showDialog' ,{
                        title: this.$i18n.t('dialog.tip'),
                        canl: this.$i18n.t('dialog.cancel'),
                        sub: this.$i18n.t('dialog.confirm'),
                        message: error.message
                    });
                }).then(()=>{
                    this.isCanceling = false;
                });
        },
        cancelTask(stockId){
            if ( this.isCanceling ) return;
            let stock = this.getCurrentTaskByStockId(stockId);
            if ( !stock || !stock.applyDetail ) return;

            return this.$store.commit('showDialog' , {
                title: this.$i18n.t('dialog.tip'),
                canl: this.$i18n.t('dialog.cancel'),
                sub: this.$i18n.t('dialog.confirm'),
                message: this.$i18n.t('dialog.contentMsg01'),
                callBack: this.cancelTaskCallBack.bind(this, stock.applyDetail.tid)
            });
        },
        modifyTask(stockId) {
            stockId = +(('' + stockId).replace(/[^0-9]/g ,''));
            let stock = this.getCurrentTaskByStockId(stockId);
            if ( !stock || !stock.applyDetail ) return;
            //融资认购
            if ( +stock.applyDetail.type === 2 ){
                let txt = this.$i18n.t("dialog.contentMsg02") + this.$options.filters['number'](stock.applyDetail.marginPart / 1000 , 2) + this.$i18n.t("dialog.contentMsg03");
                return this.$store.commit("showDialog", {
                    title: this.$i18n.t('dialog.tip'),
                    message: txt,
                    sub: this.$i18n.t('dialog.next'),
                    canl: this.$i18n.t('dialog.cancel'),
                    callBack: () => {
                        return window.location.href = '//' + this.domain.myFutu5 +'/ipo/apply?stockCode=' + stock.stockCode + '&taskId=' + stock.applyDetail.tid;
                    }
                })
            }
            return window.location.href = '//' + this.domain.myFutu5 + '/ipo/apply?stockCode=' + stock.stockCode + '&taskId=' + stock.applyDetail.tid;
        },
        /**
         * [renderIPO 先渲染IPO页面的结构]
         */
        renderIPO(stocks , isSetup){
            let newStockList = this.getNewStockList(stocks, isSetup);
            this.render = {
                isSetup : isSetup ? true : false,
                isUpIpoTime : this.isUpIpoTime(),
                isHasNewStock : stocks.length > 0 ? true : false,
                isCanSubmit : false,
                calendarIndex: 0,
                calendarList: this.getCalendar(0 , 2),
                newStockList : newStockList,
            };
        },
        /**
         * [getNewStockList 获取用于渲染页面的股票列表]
         */
        getNewStockList(stocks, isSetup){
            let newStockList = [];
            for (let i = 0 ; i < stocks.length ; i++ ){
                let stock = Object.assign({} , stocks[i]);
                let todayTime = new Date();
                let nowTime = Date.now();
                let endTime = +new Date(stock.endTime * 1000);
                //获取最大时间? 支持融资认购？
                endTime = stock.supportMargin ? Math.max(endTime , +new Date(stock.marginEndTime * 1000)) : endTime;
                //融资杠杆
                stock.marginLeverage = Math.max(Math.floor(+stock.marginLeverage) , 0) + 1;
                // 是否已过融资时间
                stock.isOverMarginTime = stock.marginEndTime * 1000 >= nowTime ? false : true;
                // 如果截止日大于今天，保留
                let isCanBuy = endTime > todayTime ? true : false;
                let isCanModify = false;
                let isCanCancel = false;
                let isCanViewDetail = false;
                stock.operations = [];

                // 认购链接
                let applyLink = `//${this.domain.myFutu5}/ipo/apply?stockCode=${stock.stockCode}`;
                // 详情链接
                let detailLink;

                stock.stockDesc = stock.stockCode + ' ' + stock.stockName;
                // 是否显示融资提示
                stock.isShowMarginTip = stock.supportMargin && !stock.isOverMarginTime;

                // 融资和普通认购最大值，实际的认购截止时间
                stock.actualEndTime = stock.supportMargin && stock.marginEndTime > stock.endTime ? stock.marginEndTime * 1000 : stock.endTime * 1000;

                if ( stock.applyDetail ){ //存在认购
                    isCanViewDetail = true;
                    isCanBuy = false;
                    detailLink = `//${this.domain.ipoFutu5}/detail?tid=${stock.applyDetail.tid}&stockCode=${stock.stockCode}`;
                    //可以操作
                    if ( +stock.applyDetail.status === 0 ){
                        //普通认购
                        if ( stock.applyDetail.type === 1 ){
                            //没有截止认购
                            if ( +new Date(stock.endTime * 1000) > todayTime ){
                                isCanModify = true;
                                isCanCancel = true;
                            }else{
                                isCanModify = false;
                                isCanCancel = false;
                            }
                        }else{
                            if ( stock.applyDetail.zeroAsset ){ //0本金认购可以撤销
                                if ( +new Date((+stock.marginEndTime || 0) * 1000) > +new Date() ){ //支持银行融资
                                    isCanModify = false;
                                    isCanCancel = true;
                                }
                            } else {
                                if ( +new Date(Math.min(stock.marginUpdateEndTime , stock.marginEndTime) * 1000) > +new Date() ){ //银行融资，支持修改，不可撤销
                                    isCanModify = true;
                                    isCanCancel = false;
                                }
                            }
                        }
                    }
                }
                // 可执行操作解析
                if (isCanBuy && isSetup) {
                    stock.operations.push({
                        href: applyLink,
                        text: this.$t("calendar.operations.apply"),
                        notGray: true  // 移动端认购按钮样式控制
                    })
                }
                if (isCanViewDetail && isSetup) {
                    stock.operations.push({
                        href: detailLink,
                        text: this.$t("calendar.operations.detail"),
                        mobileText: this.$t("calendar.operations.mobileDetail")
                    })
                }
                if (isCanModify && isSetup) {
                    stock.operations.push({
                        action: 'modifyTask',
                        text: this.$t("calendar.operations.modify")
                    })
                }
                if (isCanCancel && isSetup) {
                    stock.operations.push({
                        action: 'cancelTask',
                        text: this.$t("calendar.operations.cancel")
                    })
                }
                //日历
                stock.calendar = this.getStockCalendar(stock , 2);
                newStockList.push(stock);
            }
            return newStockList;
        },
        // 操作回调函数的处理
        handleOperation(name, param) {
            let func = this[name];
            if (func && typeof func === 'function') {
                func.call(this, param);
            } else {
                return false;
            }
        },
        /**
         * [getStockCalendar 获取单只股票日历]
         */
        getStockCalendar(stock , size){
            let todayTime = date.date2number(new Date());
            let endTime = +new Date(stock.endTime * 1000);
            //获取最大时间? 支持融资认购？
            endTime = stock.supportMargin ? Math.max(endTime , +new Date(stock.marginEndTime * 1000)) : endTime;
            endTime = date.date2number(new Date(endTime));
            //公布结果日期
            let publishTime = date.date2number(new Date(stock.publishTime * 1000));
            //上市日期
            let boardTime = date.date2number(new Date(stock.boardTime * 1000));
            let calendars = [];
            //4周日历，分2部分
            for ( let i = 0 ; i < 2 ; i++ ){
                let firstDate = !i ? new Date() : new Date(+new Date() + (size * 5 * i) * 24 * 3600 * 1000 );
                let weeks = date.getWeeks(size , firstDate);
                let calendar = [];
                for ( let j = 0 ; j < weeks.length - 4 ; j++ ){
                    // 转换为20170504这样的8位数字
                    let dateItemNumber = date.date2number(weeks[j]);
                    let className = '';
                    if( dateItemNumber >= todayTime && dateItemNumber <= endTime ){
                        className = this.illustrations['newStockStatusApply'].class;
                    }else if(dateItemNumber === publishTime ){
                        className = this.illustrations['newStockStatusPublish'].class;
                    }else if(dateItemNumber === boardTime ){
                        className = this.illustrations['newStockStatusIpo'].class;
                    }
                    calendar.push({
                        className: className,
                    });
                }
                calendars.push([].concat(calendar));
            }
            return calendars;
        },
        showError(error) {
            console.log('[showError] error: ' , error.message);
            this.$store.commit('showDialog' , error.message || 'error');
        },
        setIPOList(lists) {
            this.renderIPO(lists, this.params.isSetup);
        },
        getIPOList() {
            return xhr.get({url: '/api/getIPOList'}).then(checkResponse , handlerError)
        }
    },
    mounted() {
        this.params = _params;
        this.$store.commit('showLoading');
        this.getIPOList().then((res) => {
            return this.setIPOList(res);
        }).catch(this.showError.bind(this))
        .then(()=>{
            this.$store.commit('hideLoading');
        });
    },
    components: {uiLoading , uiDialog , uiLightDialog}
}
</script>
